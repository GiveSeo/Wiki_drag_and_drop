name: Generate PDF from Wiki

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  repository_dispatch:
    types: [wiki-updated]
  push:
    branches:
      - master

jobs:
  build-pdf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Clone Wiki repository
        run: |
          git clone https://${{ secrets.GH_PAT }}@github.com/GiveSeo/Wiki_drag_and_drop.wiki.git wiki
          cd wiki
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Cache LaTeX packages
        uses: actions/cache@v3
        with:
          path: |
            /usr/share/texlive
            /usr/share/texmf
          key: ${{ runner.os }}-texlive-${{ hashFiles('**/*.md') }}
          restore-keys: |
            ${{ runner.os }}-texlive-

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            pandoc \
            texlive-xetex \
            texlive-fonts-recommended \
            texlive-lang-cjk \
            texlive-latex-extra \
            texlive-lang-chinese \
            lmodern \
            fonts-noto-cjk
          fc-list :lang=ko family | head -5
          echo "âœ… Dependencies installed"

      - name: Merge Wiki files and download images
        run: |
          cd wiki
          echo "# Wiki Documentation" > combined.md
          echo "" >> combined.md
          echo "---" >> combined.md
          echo "" >> combined.md
          mkdir -p downloaded_images
          find . -name "*.md" ! -name "combined.md" ! -path "./.git/*" -print0 | sort -z | while IFS= read -r -d '' file; do
            echo "" >> combined.md
            echo "---" >> combined.md
            echo "" >> combined.md
            filename=$(basename "$file" .md)
            echo "# ðŸ“„ $filename" >> combined.md
            echo "" >> combined.md
            cat "$file" >> combined.md
          done
          grep -oP '!\[.*?\]\(\K(https?://[^)]+)' combined.md | sort -u | while read -r url; do
            filename=$(echo "$url" | md5sum | cut -d' ' -f1)
            extension="${url##*.}"
            [ ${#extension} -gt 4 ] && extension="jpg"
            curl -L -s --max-time 10 "$url" -o "downloaded_images/${filename}.${extension}" || true
            [ -f "downloaded_images/${filename}.${extension}" ] && sed -i "s|$url|downloaded_images/${filename}.${extension}|g" combined.md
          done

      - name: Generate PDF
        run: |
          cd wiki
          fc-cache -fv
          echo "ðŸ“ ì„¤ì¹˜ëœ Noto í°íŠ¸:"
          fc-list | grep -i "noto.*cjk.*kr" | cut -d: -f2 | sort -u
          
          # ë§¤ìš° ê°•ë ¥í•œ ì½”ë“œ ì¤„ë°”ê¿ˆ í•´ê²°ì„ ìœ„í•œ LaTeX í—¤ë” ìƒì„±
          cat > header.tex << 'EOF'
          % ëª¨ë“  í•„ìš”í•œ íŒ¨í‚¤ì§€ ë¡œë“œ
          \usepackage{fvextra}
          \usepackage{listings}
          \usepackage{xcolor}
          \usepackage{seqsplit}
          \usepackage{url}
          
          % ê¸°ë³¸ Verbatim í™˜ê²½ ì„¤ì • - ë§¤ìš° ì ê·¹ì ì¸ ì¤„ë°”ê¿ˆ
          \fvset{
            breaklines=true,
            breakanywhere=true,
            breakautoindent=false,
            breaksymbolleft={},
            breaksymbolright={},
            fontsize=\footnotesize,
            baselinestretch=1
          }
          
          % Highlighting í™˜ê²½ (ì½”ë“œ êµ¬ë¬¸ ê°•ì¡°ìš©) - ë” ì ê·¹ì ìœ¼ë¡œ ì¤„ë°”ê¿ˆ
          \DefineVerbatimEnvironment{Highlighting}{Verbatim}{
            breaklines=true,
            breakanywhere=true,
            breakautoindent=false,
            breaksymbolleft={},
            breaksymbolright={},
            commandchars=\\\{\},
            fontsize=\footnotesize,
            baselinestretch=1
          }
          
          % verbatim í™˜ê²½ë„ ë™ì¼í•˜ê²Œ ì„¤ì •
          \RecustomVerbatimEnvironment{verbatim}{Verbatim}{
            breaklines=true,
            breakanywhere=true,
            breakautoindent=false,
            breaksymbolleft={},
            breaksymbolright={},
            fontsize=\footnotesize,
            baselinestretch=1
          }
          
          % ì¸ë¼ì¸ ì½”ë“œë¥¼ ìœ„í•œ ìƒˆë¡œìš´ ëª…ë ¹ì–´ ì •ì˜
          \newcommand{\inlinecode}[1]{%
            \texttt{\seqsplit{#1}}%
          }
          
          % \texttt ìž¬ì •ì˜ - seqsplit ì‚¬ìš©ìœ¼ë¡œ ëª¨ë“  ë¬¸ìžì—ì„œ ì¤„ë°”ê¿ˆ ê°€ëŠ¥
          \let\oldtexttt\texttt
          \renewcommand{\texttt}[1]{%
            \begingroup
            \footnotesize
            \oldtexttt{\seqsplit{#1}}%
            \endgroup
          }
          
          % URL ìŠ¤íƒ€ì¼ë„ ì¤„ë°”ê¿ˆ ê°€ëŠ¥í•˜ê²Œ
          \def\UrlBreaks{\do\/\do-\do.\do:\do_\do(\do)\do[\do]\do\{\do\}}
          
          % íŽ˜ì´ì§€ ë ˆì´ì•„ì›ƒ ìµœì í™”
          \usepackage{microtype}
          \usepackage[hang,flushmargin]{footmisc}
          
          % ë‹¨ë½ ê°„ê²© ì¡°ì •
          \setlength{\parskip}{0.5\baselineskip}
          \setlength{\parindent}{0pt}
          EOF
          
          pandoc combined.md \
            --pdf-engine=xelatex \
            --listings \
            -V 'mainfont:Noto Sans CJK KR' \
            -V 'sansfont:Noto Sans CJK KR' \
            -V 'monofont:Noto Sans Mono CJK KR' \
            -V 'CJKmainfont:Noto Sans CJK KR' \
            -V fontsize=11pt \
            -V geometry:margin=1.2cm \
            -V linestretch=1.2 \
            -V documentclass=article \
            --toc \
            --toc-depth=3 \
            -H header.tex \
            -o combined.pdf

      - name: Commit PDF to repository
        run: |
          mv wiki/combined.pdf Wiki_ì „ì²´.pdf
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GH_PAT }}@github.com/GiveSeo/Wiki_drag_and_drop.git
          git fetch origin
          git pull origin HEAD --rebase || true
          git add Wiki_ì „ì²´.pdf
          if ! git diff --staged --quiet; then
            git commit -m "ðŸ“„ Update Wiki PDF"
            git push origin HEAD
          fi

      - name: Update Home.md with PDF link
        run: |
          cd wiki
          PDF_URL_RAW="https://github.com/GiveSeo/Wiki_drag_and_drop/raw/master/Wiki_ì „ì²´.pdf"
          PDF_URL_BLOB="https://github.com/GiveSeo/Wiki_drag_and_drop/blob/master/Wiki_ì „ì²´.pdf"
          HOME_FILE="Home.md"
          
          # ê¸°ì¡´ PDF ë‹¤ìš´ë¡œë“œ ì„¹ì…˜ ì™„ì „ ì œê±°
          if grep -q "## ðŸ“˜ PDF ë‹¤ìš´ë¡œë“œ" "$HOME_FILE"; then
            sed -i '/## ðŸ“˜ PDF ë‹¤ìš´ë¡œë“œ/,/^$/d' "$HOME_FILE"
          fi
          
          # íŒŒì¼ ëì— PDF ë‹¤ìš´ë¡œë“œ ì„¹ì…˜ ì¶”ê°€
          echo "" >> "$HOME_FILE"
          echo "---" >> "$HOME_FILE"
          echo "" >> "$HOME_FILE"
          echo "## ðŸ“˜ PDF ë‹¤ìš´ë¡œë“œ" >> "$HOME_FILE"
          echo "" >> "$HOME_FILE"
          echo "ì „ì²´ Wikië¥¼ PDFë¡œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤:" >> "$HOME_FILE"
          echo "" >> "$HOME_FILE"
          echo "- [ðŸ“¥ PDF ë‹¤ìš´ë¡œë“œ (Raw)]($PDF_URL_RAW)" >> "$HOME_FILE"
          echo "- [ðŸ‘ï¸ GitHubì—ì„œ ë³´ê¸°]($PDF_URL_BLOB)" >> "$HOME_FILE"
          echo "" >> "$HOME_FILE"
          
          git remote set-url origin https://x-access-token:${{ secrets.GH_PAT }}@github.com/GiveSeo/Wiki_drag_and_drop.wiki.git
          git add "$HOME_FILE"
          if ! git diff --staged --quiet; then
            git commit -m "ðŸ”— Update PDF download link"
            git push origin HEAD:master
          fi
