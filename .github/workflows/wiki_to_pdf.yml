name: Generate PDF from Wiki

on:
  schedule:
    - cron: '0 0 * * *'  # 매일 자정 (UTC)
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  build-pdf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Clone Wiki repository
        run: |
          git clone https://${{ secrets.GH_PAT }}@github.com/GiveSeo/Wiki_drag_and_drop.wiki.git wiki
          cd wiki
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended texlive-lang-cjk fonts-unfonts-core

      - name: Merge Wiki files and download images
        run: |
          cd wiki
          echo "# Wiki Documentation" > combined.md
          echo "" >> combined.md
          echo "---" >> combined.md
          echo "" >> combined.md
          
          mkdir -p downloaded_images
          
          find . -name "*.md" ! -name "combined.md" ! -path "./.git/*" -print0 | sort -z | while IFS= read -r -d '' file; do
            echo "" >> combined.md
            echo "---" >> combined.md
            echo "" >> combined.md
            cat "$file" >> combined.md
          done
          
          grep -oP '!\[.*?\]\(\K(https?://[^)]+)' combined.md | sort -u | while read -r url; do
            filename=$(echo "$url" | md5sum | cut -d' ' -f1)
            extension="${url##*.}"
            [ ${#extension} -gt 4 ] && extension="jpg"
            curl -L -s --max-time 10 "$url" -o "downloaded_images/${filename}.${extension}" || true
            [ -f "downloaded_images/${filename}.${extension}" ] && sed -i "s|$url|downloaded_images/${filename}.${extension}|g" combined.md
          done

      - name: Generate PDF
        run: |
          cd wiki
          pandoc combined.md \
            --pdf-engine=xelatex \
            -V mainfont="UnBatang" \
            -V CJKmainfont="UnBatang" \
            -V fontsize=11pt \
            -V geometry:margin=1.5cm \
            -V linestretch=1.2 \
            --toc \
            --toc-depth=3 \
            -o combined.pdf

      - name: Commit PDF to repository
        run: |
          mv wiki/combined.pdf Wiki_전체.pdf
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GH_PAT }}@github.com/GiveSeo/Wiki_drag_and_drop.git
          
          git fetch origin
          git pull origin HEAD --rebase || true
          
          git add Wiki_전체.pdf
          
          if ! git diff --staged --quiet; then
            git commit -m "📄 Update Wiki PDF"
            git push origin HEAD
          fi
